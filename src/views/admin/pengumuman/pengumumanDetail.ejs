<!DOCTYPE html>
<html>
<head>
    <title>Detail Pengumuman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        function formatTanggalIndonesia(tanggal) {
            if (!tanggal) return '';
            const hari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const bulan = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            const date = new Date(tanggal);
            const namaHari = hari[date.getDay()];
            const tanggalNum = date.getDate();
            const namaBulan = bulan[date.getMonth()];
            const tahun = date.getFullYear();
            return `${namaHari}, ${tanggalNum} ${namaBulan} ${tahun}`;
        }
    </script>
</head>
<body class="bg-gray-50 relative">
    <%- include('../../partials/navbar') %>

    <div class="max-w-7xl mx-auto mt-8 flex flex-col lg:flex-row gap-8 px-4">
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                <%= error %>
            </div>
        <% } %>

        <% if (typeof success !== 'undefined' && success) { %>
            <div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                <%= success %>
            </div>
        <% } %>
        <!-- Kiri: Detail -->
        <div class="flex-1 bg-white rounded shadow p-6">
            <h2 class="text-3xl font-bold mb-6">
                <%= pengumuman.nama_pengumuman %>
                <% if (pengumuman.foto) { %>
                <div class="mt-4">
                    <img src="/uploads/foto/pengumuman/<%= pengumuman.foto %>" alt="Foto Pengumuman" class="max-h-60 rounded shadow">
                </div>
                <% } %>
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-gray-700 mb-6">
                <!-- Tanggal Pengumuman -->
                <div class="flex items-start gap-3">
                    <div class="text-2xl mt-1">üìÖ</div>
                    <div>
                        <p class="font-semibold">Tanggal Pengumuman</p>
                        <p>
                            <span id="tanggalDetail" class="inline-block"></span>
                        </p>
                    </div>
                </div>
                <!-- Kategori -->
                <div class="flex items-start gap-3">
                    <div class="text-2xl mt-1">üè∑Ô∏è</div>
                    <div>
                        <p class="font-semibold">Kategori</p>
                        <p><%= pengumuman.kategori_pengumuman %></p>
                    </div>
                </div>
                <!-- Status -->
                <div class="flex items-start gap-3">
                    <div class="text-2xl mt-1">üìå</div>
                    <div>
                        <p class="font-semibold">Status</p>
                        <span class="inline-block px-3 py-1 text-sm font-medium rounded-full 
                                   <%= pengumuman.status_pengumuman === 'Dipublikasi' ? 'bg-green-100 text-green-800' : 
                                       pengumuman.status_pengumuman === 'Draft' ? 'bg-yellow-100 text-yellow-800' : 
                                       'bg-gray-100 text-gray-800' %>">
                            <%= pengumuman.status_pengumuman %>
                        </span>
                    </div>
                </div>
                <div class="flex items-start gap-3 mt-2">
                    <div class="text-2xl mt-1">üßë‚Äçüè´</div>
                    <div>
                        <p class="font-semibold">Kegiatan Desa</p>
                        <span class="inline-block px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800">
                            <%= (kegiatanUtama && kegiatanUtama.nama_kegiatan) ? kegiatanUtama.nama_kegiatan : '-' %>
                        </span>
                    </div>
                </div>
                <!-- Prioritas -->
                <div class="flex items-start gap-3">
                    <div class="text-2xl mt-1">‚ö°</div>
                    <div>
                        <p class="font-semibold">Prioritas</p>
                        <span class="inline-block px-3 py-1 text-sm font-medium rounded-full 
                                   <%= pengumuman.prioritas === 'Sangat Penting' ? 'bg-red-100 text-red-800' : 
                                       pengumuman.prioritas === 'Penting' ? 'bg-orange-100 text-orange-800' : 
                                       'bg-gray-100 text-gray-800' %>">
                            <%= pengumuman.prioritas %>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Isi Pengumuman -->
            <div class="mb-6 text-gray-700">
                <div class="flex items-start gap-3">
                    <div class="text-2xl mt-1">üìù</div>
                    <div>
                        <p class="font-semibold mb-1">Isi Pengumuman</p>
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="whitespace-pre-wrap"><%= pengumuman.isi_pengumuman %></p>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Aksi -->
            <div class="flex gap-4 flex-wrap">
                <a href="/admin/pengumuman/edit/<%= pengumuman.id_pengumuman_desa %>" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Edit</a>
                <button onclick="togglePengumumanStatus('<%= pengumuman.id_pengumuman_desa %>', '<%= pengumuman.status_pengumuman %>')" 
                        class="px-4 py-2 <%= pengumuman.status_pengumuman === 'Dipublikasi' ? 'bg-orange-500' : 'bg-green-500' %> text-white rounded hover:opacity-80">
                    <%= pengumuman.status_pengumuman === 'Dipublikasi' ? 'Draft' : 'Publikasi' %>
                </button>
                <form action="/admin/pengumuman/hapus/<%= pengumuman.id_pengumuman_desa %>" method="POST" class="inline" onsubmit="return confirm('Yakin ingin menghapus pengumuman ini? Tindakan ini tidak dapat dibatalkan.')">
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Hapus
                    </button>
                </form>
                <a href="/admin/pengumuman" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Kembali</a>
            </div>
        </div>

        <!-- Kanan: Daftar Pengumuman Lainnya -->
        <div class="w-full lg:w-80 flex flex-col gap-2">
            <div class="mb-2">
                <h3 class="text-lg font-bold text-gray-700">Pengumuman Lainnya</h3>
                <p class="text-xs text-gray-500">Scroll ke bawah untuk melihat semua pengumuman</p>
            </div>

            <div class="w-full h-[690px] overflow-y-auto flex flex-col gap-4 pr-1">
                <% if (typeof pengumumanList !== 'undefined') { %>
                    <% pengumumanList.forEach(item => { if (item.id_pengumuman_desa !== pengumuman.id_pengumuman_desa) { %>
                    <a href="/admin/pengumuman/<%= item.id_pengumuman_desa %>" class="flex items-start bg-white rounded shadow p-4 hover:bg-blue-50 transition">
                        <div class="w-16 h-16 bg-gray-100 rounded mr-4 flex items-center justify-center overflow-hidden">
                            <% if (item.foto) { %>
                                <img src="/uploads/foto/pengumuman/<%= item.foto %>" alt="Foto Pengumuman" class="object-cover w-full h-full rounded">
                            <% } else { %>
                                <span class="text-2xl">üì¢</span>
                            <% } %>
                        </div>
                        <div class="flex-1 text-sm text-gray-700">
                            <div class="flex items-center gap-2 font-semibold text-md mb-1">
                                <%= item.nama_pengumuman %>
                            </div>
                            <div class="flex items-center gap-2 mb-1 text-gray-600">
                                <span class="text-xs">üìÖ</span>
                                <script>document.write(formatTanggalIndonesia('<%= item.tanggal_pengumuman %>'));</script>
                            </div>
                            <div class="flex items-center gap-2 mb-1 text-gray-600">
                                <span class="text-xs">üè∑Ô∏è</span>
                                <%= item.kategori_pengumuman %>
                            </div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs">üìå</span>
                                <span class="inline-block px-2 py-1 text-xs font-medium rounded-full 
                                           <%= item.status_pengumuman === 'Dipublikasi' ? 'bg-green-100 text-green-800' : 
                                               item.status_pengumuman === 'Draft' ? 'bg-yellow-100 text-yellow-800' : 
                                               'bg-gray-100 text-gray-800' %>">
                                    <%= item.status_pengumuman %>
                                </span>
                            </div>
                            <% if (item.id_kegiatan_desa) { %>
                                <% const kegiatan = (typeof kegiatanDesaList !== 'undefined') ? kegiatanDesaList.find(k => k.id_kegiatan_desa == item.id_kegiatan_desa) : null; %>
                                <% if (kegiatan) { %>
                                    <div class="mt-2 p-2 bg-gray-100 rounded">
                                        <div class="font-semibold text-xs text-blue-700 mb-1">Kegiatan Desa Terkait:</div>
                                        <div class="text-xs text-gray-700"><b><%= kegiatan.nama_kegiatan %></b></div>
                                    </div>
                                <% } %>
                            <% } %>
                        </div>
                    </a>
                    <% } }) %>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Riwayat Aktivitas Modal (Opsional) -->
    <% if (typeof pengumumanActivities !== 'undefined' && pengumumanActivities.length > 0) { %>
    <div id="modalAktivitas" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Riwayat Aktivitas</h3>
                    <button onclick="tutupModalAktivitas()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktivitas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <% pengumumanActivities.forEach(activity => { %>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <%= activity.description %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <%= new Date(activity.created_at).toLocaleString('id-ID') %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                        Berhasil
                                    </span>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <% } %>

    <script>
        // Format tanggal utama
        document.getElementById('tanggalDetail').innerText = formatTanggalIndonesia('<%= pengumuman.tanggal_pengumuman %>');

        // Toggle status pengumuman
        function togglePengumumanStatus(pengumumanId, currentStatus) {
            const newStatus = currentStatus === 'Dipublikasi' ? 'Draft' : 'Dipublikasi';
            if (confirm(`Yakin ingin mengubah status pengumuman menjadi ${newStatus}?`)) {
                fetch(`/admin/pengumuman/toggle-status/${pengumumanId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status_pengumuman: newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Gagal mengubah status pengumuman');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Terjadi kesalahan saat mengubah status');
                });
            }
        }

        // Modal aktivitas handlers (jika ada)
        function bukaModalAktivitas() {
            document.getElementById('modalAktivitas').classList.remove('hidden');
            document.getElementById('modalAktivitas').classList.add('flex');
        }

        function tutupModalAktivitas() {
            document.getElementById('modalAktivitas').classList.remove('flex');
            document.getElementById('modalAktivitas').classList.add('hidden');
        }
    </script>
</body>
</html>